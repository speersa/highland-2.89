//TString key[3]={"h1","h2","oldbanff"};
//TString inh1="hist_ft_"+key[0]+"_10_5Frun2w_5Ftables_reg20.root";
//TString inh2="hist_fth2_"+key[1]+"_500_5Frun2w_5Ftables_reg20.root";
//TString inbf="hist_ft_"+key[2]+"_500_5Frun2w_5Ftables_reg20.root";

TString stleg[3]={"FGD1","FGD1","FGD2"};
TString pathprod[3]={"numuCCFGD","numuCCFGD","numuCCFGD"};
TString key[3]={"h2","h2","h2"};
TString key2[3]={"_reg20","_reg20","_reg20"};
TString inh1="hist_fth2_"+key[0]+"_500_6Brun2w_6Btables_patchHEAD"+key2[0]+".root";
TString inh2="hist_fth2_"+key[1]+"_500_6Brun2w_6Btables_patchHEAD"+key2[1]+".root";
TString inbf="hist_fth2_"+key[2]+"_500_6Brun2w_6Btables_patch2HEAD"+key2[2]+".root";
TString inh1sand="hist_fth2_"+key[0]+"_500_6Brun3aSAND_6Btables_patch12HEAD1"+key2[0]+".root";
TString inh2sand="hist_fth2_"+key[1]+"_500_6Brun3aSAND_6Btables_patchHEAD"+key2[1]+".root";
TString inbfsand="hist_fth2_"+key[2]+"_500_6Brun3aSAND_6Btables_patch2HEAD"+key2[2]+".root";


/*
TString stleg[3]={"FGD1(psy)","FGD1(h2)","FGD2(h2)"};
TString pathprod[3]={"numuCCFGD","numuCCFGD","numuCCFGD"};
TString key[3]={"psy","h2","h2"};
TString key2[3]={"_reg20","_reg20","_reg20"};
TString inh1="hist_fth2_"+key[0]+"_500_6Brun2w_6Btables_patchHEAD"+key2[0]+".root";
TString inh2="hist_fth2_"+key[1]+"_500_6Brun2w_6Btables_patchHEAD"+key2[1]+".root";
TString inbf="hist_fth2_"+key[2]+"_500_6Brun2w_6Btables_patch2HEAD"+key2[2]+".root";
TString inh1sand="hist_fth2_"+key[0]+"_500_6Brun3aSAND_6Btables_patch12HEAD1"+key2[0]+".root";
TString inh2sand="hist_fth2_"+key[1]+"_500_6Brun3aSAND_6Btables_patchHEAD"+key2[1]+".root";
TString inbfsand="hist_fth2_"+key[2]+"_500_6Brun3aSAND_6Btables_patch2HEAD"+key2[2]+".root";
*/

/*
TString stleg[3]={"FGD2 (psy-12)"," FGD2 (h2)","FGD2 (psy)"};
TString pathprod[3]={"numuCCFGD","numuCCFGD","numuCCFGD"};
TString key[3]={"psy","h2","psy"};
TString key2[3]={"_reg20","_reg20","_reg20"};
TString inh1="hist_fth2_"+key[0]+"_500_6Brun2w_6Btables_patch12HEAD2"+key2[0]+".root";
TString inh2="hist_fth2_"+key[1]+"_500_6Brun2w_6Btables_patch2HEAD"+key2[1]+".root";
TString inbf="hist_fth2_"+key[2]+"_500_6Brun2w_6Btables_patch2HEAD"+key2[2]+".root";
TString inh1sand="hist_fth2_"+key[0]+"_500_6Brun3aSAND_6Btables_patch12HEAD2"+key2[0]+".root";
TString inh2sand="hist_fth2_"+key[1]+"_500_6Brun3aSAND_6Btables_patch2HEAD"+key2[1]+".root";
TString inbfsand="hist_fth2_"+key[2]+"_500_6Brun3aSAND_6Btables_patch2HEAD"+key2[2]+".root";
*/
/*
TString stleg[3]={"5F files, 5F tables","6B files, 6B tables","6B files, 5F tables"};
TString pathprod[3]={"numuCCFGD1","numuCCFGD","numuCCFGD1"};
TString key[3]={"h2","h2","h2"};
TString key2[3]={"_reg20","_reg20","_reg20"};
TString inh1="hist_fth2_"+key[0]+"_500_5Frun2w_5Ftables_v0r29-v0r37"+key2[0]+".root";
TString inh2="hist_fth2_"+key[1]+"_500_6Brun2w_6Btables_patchHEAD"+key2[2]+".root";
TString inh2sand="hist_fth2_"+key[1]+"_500_6Brun3aSAND_6Btables_patchHEAD"+key2[2]+".root";
TString inbf="hist_fth2_"+key[2]+"_500_6Brun2w_5Ftables_v0r10-v1r14"+key2[1]+".root";
*/

/*
TString stleg[3]={"FGD1 (psy-12)"," FGD1 (h2)","FGD1 (psy)"};
TString pathprod[3]={"numuCCFGD","numuCCFGD","numuCCFGD"};
TString key[3]={"psy","h2","psy"};
TString key2[3]={"_reg20","_reg20","_reg20"};
TString inh1="hist_fth2_"+key[0]+"_500_6Brun2w_6Btables_patch12HEAD1"+key2[0]+".root";
TString inh2="hist_fth2_"+key[1]+"_500_6Brun2w_6Btables_patchHEAD"+key2[2]+".root";
TString inh2sand="hist_fth2_"+key[1]+"_500_6Brun3aSAND_6Btables_patchHEAD"+key2[2]+".root";
TString inbf="hist_fth2_"+key[2]+"_500_6Brun2w_6Btables_patchHEAD"+key2[1]+".root";
*/ 
/*
TString key[3]={"psy","h2","h2"};
TString key2[3]={"_reg20","_reg20","_reg20"};
TString inh1="hist_fth2_"+key[0]+"_500_6Brun2w_6Btables_patch12HEAD2"+key2[0]+".root";
TString inh2="hist_fth2_"+key[1]+"_500_6Brun2w_6Btables_patchHEAD"+key2[1]+".root";
TString inbf="hist_fth2_"+key[2]+"_500_6Brun2w_6Btables_patch2HEAD"+key2[2]+".root";
TString inh2sand="hist_fth2_"+key[2]+"_500_6Brun3aSAND_6Btables_patchHEAD"+key2[2]+".root";
*/

float sanderror[4]={0};
TH1F *hhsand[4][3]={NULL};
TH2F *hcovsand[4][3]={NULL};
float computetotalerror(TH2F *hcov, TH1F *hnom){
  int nbins=hnom->GetXaxis()->GetNbins();
  int nbins2=hcov->GetXaxis()->GetNbins();
  if(nbins!=nbins2){ 
    std::cout<<" ERROR: nbins are not the same"<<std::endl;
    return 0;
  }
  float abserr=0;
  float relerr=0;
  float ntot=0;
  for(int ib=0;ib<nbins;ib++){
    for(int jb=0;jb<nbins;jb++){
      float cov=hcov->GetBinContent(ib+1,jb+1);
      float ni=hnom->GetBinContent(ib+1);
      float nj=hnom->GetBinContent(jb+1);
      abserr+=cov*ni*nj;
    }
    ntot+=hnom->GetBinContent(ib+1);
  }
  relerr=sqrt(abserr)/ntot;
  return relerr;
}

void makesandmuonsysthist(){
  TFile *infsand[3]={NULL};
  TFile *infnom[3]={NULL};

  infsand[0]= new TFile(inh1sand.Data(),"READ");
  infnom[0] = new TFile(inh1.Data(),"READ");

  infsand[1]= new TFile(inh2sand.Data(),"READ");
  infnom[1] = new TFile(inh2.Data(),"READ");

  infsand[2]= new TFile(inbfsand.Data(),"READ");
  infnom[2] = new TFile(inbf.Data(),"READ");

  TString systname="sandmu";
  TString systname_dir="sandmu_syst";
  TString systlatex="Sand muon background";

  TString nn[4]={"CC","CC0pi","CC1pi","CCOth"};
  //  TString path="numuCCFGD";

  float POTnorm=12.05/5.4;//nom/sand
  
  TCanvas *c1[4];
  TH1F *hh[4][3];
  TH1F *hnom[4][3];
  TH1F *hnomsand[4][3];
  for(int ih=0;ih<4;ih++){
    c1[ih]=new TCanvas(Form("c1%s%d",systname.Data(),ih),Form("c1%s%d",systname.Data(),ih),1);
    for(int iff=0;iff<3;iff++){
      TString path3=pathprod[iff]+"/"+systname_dir+"/"+nn[ih];
      std::cout<<"iff "<<iff<<""<<path3<<std::endl;
      infsand[iff]->cd(path3.Data());
      TString pathnom=pathprod[iff]+"/"+nn[ih]+key2[iff];      
      if(infsand[iff] && infnom[iff]){
	hhsand[ih][iff]=   (TH1F*) infsand[iff]->Get(Form("%s/relerr_%s_%s_%s",path3.Data(),key[iff].Data(),systname.Data(),nn[ih].Data()));
	hcovsand[ih][iff]= (TH2F*) infsand[iff]->Get(Form("%s/relcov_%s_%s_%s",path3.Data(),key[iff].Data(),systname.Data(),nn[ih].Data()));
	hnomsand[ih][iff]= (TH1F*) infsand[iff]->Get(Form("%s/mom_%s_%s",pathnom.Data(),key[iff].Data(),nn[ih].Data()));
	infnom[iff]->cd();
	infnom[iff]->cd(pathnom.Data());
	//infnom[iff]->ls();
	std::cout<<pathnom<<std::endl;
	hnom[ih][iff]= (TH1F*) infnom[iff]->Get(Form("%s/mom_%s_%s",pathnom.Data(),key[iff].Data(),nn[ih].Data()));
	if(hnom[ih][iff] && hnomsand[ih][iff] && hcovsand[ih][iff]){
	  int nbins=hnom[ih][iff]->GetXaxis()->GetNbins();
	  int nbins2=hnomsand[ih][iff]->GetXaxis()->GetNbins();
	  int nbins3=hcovsand[ih][iff]->GetXaxis()->GetNbins();
	  if(nbins!=nbins2 || nbins!=nbins3 || nbins2!=nbins3) 
	    std::cout<<" ERROR: don't have the same binning! "<<std::endl;
	  
	  for(int ib=0;ib<nbins;ib++){
	    float val=hhsand[ih][iff]->GetBinContent(ib+1);
	    float ni =hnom[ih][iff]->GetBinContent(ib+1);
	    float nisand =hnomsand[ih][iff]->GetBinContent(ib+1)*POTnorm;
	    hhsand[ih][iff]->SetBinContent(ib+1,val*nisand/ni);
	    for(int jb=0;jb<nbins;jb++){
	      float njsand =hnomsand[ih][iff]->GetBinContent(jb+1)*POTnorm;
	      float nj   =hnom[ih][iff]->GetBinContent(jb+1);
	      float valij=hcovsand[ih][iff]->GetBinContent(ib+1,jb+1);
	      hcovsand[ih][iff]->SetBinContent(ib+1,jb+1,valij*nisand*njsand/(ni*nj));
	    }
	  }
	}
	if(hhsand[ih][iff])std::cout<<"SAND ih "<<ih<<" iff "<<iff<<" exists! "<<std::endl;
      }
    }
  }
}

void compareprodsysthist(int opt){
  makesandmuonsysthist();
  TFile *inf[3];
  inf[0]=new TFile(inh1.Data(),"READ");
  inf[1]=new TFile(inh2.Data(),"READ");
  inf[2]=new TFile(inbf.Data(),"READ");

  std::ofstream txtfile;
  if(opt==0)
    txtfile.open("latex_6B-5F.txt");
  else if(opt==1)
    txtfile.open("latex_6B-6B.txt");
  else if(opt==2)
    txtfile.open("latex_5F-5F.txt");

  char ttt[500];

  const int NSYST=17;
  TString systname[NSYST]={"bfield","momresol","momscale","tpcpid","fgdpid","chargeideff","tpcclustereff","tpctrackeff","fgdtrackeff","tpcfgdmatcheff","meeff","oofv","pileup","fgdmass","sipion","all","sandmu"};
  TString systname_dir[NSYST]={"bfield_syst","momresol_syst","momscale_syst","tpcpid_syst","fgdpid_syst","chargeideff_syst","tpcclustereff_syst","tpctrackeff_syst","fgdtrackeff_syst","tpcfgdmatcheff_syst","michel_syst","oofv_syst","pileup_syst","fgdmass_syst","sipion_syst","all_syst","sandmu_syst"};
  TString systlatex[NSYST]={"Field distortions","Momentum resolution","Momentum scale","TPC PID","FGD PID","Charge ID efficiency","TPC cluster efficiency","TPC track efficiency","FGD track efficiency","TPC-FGD matching efficiency","Michel electron","OOFV background","Pile-up","FGD mass","Pion secondary interactions","All magnet","Sand muon background"};

  TString nn[4]={"CC","CC0pi","CC1pi","CCOth"};
  
  // TString path="numuCCFGD";
  
  TCanvas *c1[4];
  float totalerror[4]={0};
  for(int isyst=0;isyst<NSYST;isyst++){
    if(isyst==0){
      sprintf(ttt," \\hline \n \\multicolumn{5}{l}{\\textbf{Observable-variation systematics}} \\\\ \n \\hline \n");txtfile<<ttt;
    }else if(isyst==5){
      sprintf(ttt," \\hline \n \\multicolumn{5}{l}{\\textbf{Efficiency-like systematics}} \\\\ \n \\hline \n");txtfile<<ttt;
    }else if(isyst==11){
      sprintf(ttt," \\hline \n \\multicolumn{5}{l}{\\textbf{Normalization systematics}} \\\\ \n \\hline \n");txtfile<<ttt;
    }else if(isyst==NSYST-2){
      sprintf(ttt," \\hline \n \\multicolumn{5}{l}{\\textbf{ALL}} \\\\ \n \\hline \n");txtfile<<ttt;
    }
    
    
    sprintf(ttt,"%s",systlatex[isyst].Data());
    txtfile<<ttt;

    TH1F *hh[4][3]={NULL};
    TH2F *hcov[4][3]={NULL};
    TH1F *hnom[4][3]={NULL};
    for(int ih=0;ih<4;ih++){
      c1[ih]=new TCanvas(Form("c1%s%d",systname[isyst].Data(),ih),Form("c1%s%d",systname[isyst].Data(),ih),1);
      for(int iff=0;iff<3;iff++){
	TString pathnom=pathprod[iff]+"/"+nn[ih]+key2[iff];
	TString path3  =pathprod[iff]+"/"+systname_dir[isyst]+"/"+nn[ih];
	TString name   = systname[isyst];
	if(systname[isyst]=="fgdtrackeff" && !inf[iff]->cd(path3.Data())){
	  TString dir="fgdhybridtrackeff_syst";
	  name ="fgdhybtrackeff";
	  path3=pathprod[iff]+"/"+dir+"/"+nn[ih];
	}
	std::cout<<" iff "<<iff<<" "<<systname[isyst]<<std::endl;
	if(inf[iff]->cd(path3.Data()) || name=="sandmu"){
	  hh[ih][iff]= (TH1F*) inf[iff]->Get(Form("%s/relerr_%s_%s_%s",path3.Data(),key[iff].Data(),name.Data(),nn[ih].Data()));
	  hcov[ih][iff]= (TH2F*) inf[iff]->Get(Form("%s/relcov_%s_%s_%s",path3.Data(),key[iff].Data(),name.Data(),nn[ih].Data()));
	  hnom[ih][iff]= (TH1F*) inf[iff]->Get(Form("%s/mom_%s_%s",pathnom.Data(),key[iff].Data(),nn[ih].Data()));
	  if(name=="sandmu"){
	    hh[ih][iff]=(TH1F*) hhsand[ih][iff];
	    hcov[ih][iff]=(TH2F*) hcovsand[ih][iff];
	    if(hh[ih][iff]) std::cout<<" filled hhsand hist "<<ih<<" file "<<iff<<std::endl;
	  }
	    
	  if(hh[ih][iff] && opt==iff){
	    float error=computetotalerror(hcov[ih][iff],hnom[ih][iff]);
	    std::cout<<systname[isyst]<<" ih "<<ih<<" iff "<<iff<<" exists! "<<error<<std::endl;
	    if(error!=error) error=0;
	    if(isyst>=NSYST-2)
	      totalerror[ih]+=pow(error,2);
	    if(opt==iff){
	      sprintf(ttt," & %.4f",error*100);
	      txtfile<<ttt;
	    }
	  }
	}
      }
      TLegend *leg;
      if(systname[isyst]=="all" || systname[isyst]=="fgdmass"){ 
	leg = new TLegend(0.7,0.15,0.88,0.35);//right bottom
      }
      else if(systname[isyst]=="tpcfgdmatcheff"  || systname[isyst]=="tpcpid"){
	leg = new TLegend(0.5,0.65,0.68,0.85);//middle top
      }
      else if(systname[isyst]=="oofv" || systname[isyst]=="pileup" || systname[isyst]=="sandmu"){
	leg = new TLegend(0.7,0.5,0.88,0.7);//middle right
      }
      else{
	leg = new TLegend(0.15,0.68,0.33,0.88);//top left
      }

      leg->SetFillColor(0);
      leg->SetLineColor(0);
      if(hh[ih][0]){
	hh[ih][0]->SetTitle(Form("%s for %s",systlatex[isyst].Data(),nn[ih].Data()));
	hh[ih][0]->SetLineColor(kBlue);
	leg->AddEntry(hh[ih][0],stleg[0].Data(),"f");
      }
      if(hh[ih][1]){
	hh[ih][1]->SetLineColor(kBlue);
	hh[ih][1]->SetMarkerColor(2);
	hh[ih][1]->SetMarkerStyle(21);
	leg->AddEntry(hh[ih][1],stleg[1].Data(),"p l");
      }
      if(hh[ih][2]){
	hh[ih][2]->SetLineWidth(2);
	hh[ih][2]->SetLineColor(7);
	leg->AddEntry(hh[ih][2],stleg[2].Data(),"f");
      }
      
      float vmax0 =-9999., vmax1=-9999., vmax2=-9999., vmax3=-9999.,vmax=1.;
      if(hh[ih][0])vmax0 = TMath::Max(-999.,hh[ih][0]->GetMaximum());
      if(hh[ih][1])vmax1 = TMath::Max(vmax0,hh[ih][1]->GetMaximum());
      vmax2=TMath::Max(vmax0,vmax1);
      if(hh[ih][2])vmax3 = TMath::Max(vmax2,hh[ih][2]->GetMaximum());
      vmax =TMath::Max(vmax2,vmax3);

      for(int iff=0;iff<3;iff++)
	if(hh[ih][iff])hh[ih][iff]->GetYaxis()->SetRangeUser(0.,vmax*1.1);
      if(hh[ih][0])      hh[ih][0]->Draw();
      else if(hh[ih][1]) hh[ih][1]->Draw();
      else if(hh[ih][2]) hh[ih][2]->Draw();
      
      if(hh[ih][1]) hh[ih][1]->Draw("p same");    
      if(hh[ih][2]) hh[ih][2]->Draw("same");

      leg->Draw("same");
      //c1[ih]->Print(Form("numuValidation/%s_%s_H2-v0r21p0.eps",name.Data(),nn[ih].Data()));
      c1[ih]->Print(Form("numuValidation/fgd1fgd2%s_%s.eps",name.Data(),nn[ih].Data()));
    }
    txtfile<<"\\\\ \n";
  }
  txtfile<<"TOTAL";
  for(int ih=0;ih<4;ih++){
    sprintf(ttt," & %.4f",sqrt(totalerror[ih])*100);
    txtfile<<ttt;
  }
  txtfile<<"\\\\ \n \\hline";
  txtfile.close();
}


